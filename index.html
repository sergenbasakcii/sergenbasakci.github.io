<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RSVP Okuyucu – Tek Dosya</title>
<style>
  :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg);}
  .wrap{max-width:900px;margin:auto;padding:20px;}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0;}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px;}
  #screen{display:flex;justify-content:center;align-items:center;height:240px;font-size:56px;letter-spacing:.5px;}
  #screen b{color:var(--accent)}
  textarea{width:100%;min-height:160px;background:#0b1220;color:var(--fg);border:1px solid #1f2937;border-radius:12px;padding:12px}
  input[type="range"]{width:220px}
  button{background:#1f2937;border:1px solid #334155;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
  button.primary{background:#2563eb;border-color:#2563eb}
  .label{font-size:14px;color:var(--muted)}
  .pill{background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:6px 10px}
  .grow{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>⚡ RSVP Okuyucu – Tek Dosya</h1>
  <div class="card"><div id="screen">Hazır</div></div>
  <div class="card">
    <div class="row">
      <span class="label">Hız (WPM)</span>
      <input id="wpm" type="range" min="150" max="1000" value="400" step="10">
      <span id="wpmVal" class="pill">400</span>
      <span class="label">Chunk</span>
      <select id="chunk">
        <option value="1" selected>1 kelime</option>
        <option value="2">2 kelime</option>
        <option value="3">3 kelime</option>
      </select>
      <label class="pill"><input id="orp" type="checkbox" checked> ORP vurgusu</label>
      <label class="pill"><input id="breath" type="checkbox" checked> Nefes molası</label>
      <span id="progress" class="label">0 / 0</span>
      <div class="grow"></div>
      <button id="back10">⟲ 10</button>
      <button id="toggle" class="primary">Başlat</button>
      <button id="fwd10">10 ⟳</button>
    </div>
    <div class="row">
      <span class="label">Metni yapıştır (PDF yerine):</span>
      <div class="grow"></div>
      <button id="loadSample">Örnek yükle</button>
      <button id="reset">Sıfırla</button>
    </div>
    <textarea id="input" placeholder="Buraya düz metin yapıştır."></textarea>
  </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  }

  const calcOrpIndex = (word) => {
    const len = word.length;
    if (len <= 1) return 0;
    if (len <= 5) return 1;
    if (len <= 9) return 2;
    return Math.min(3, len - 1);
  };
  const punctDelay = (token) => {
    const t = token.trim();
    if (/[.!?]$/.test(t)) return 300;
    if (/[,;:]$/.test(t)) return 120;
    if (t.includes("—")) return 200;
    return 0;
  };
  const normalize = (txt) =>
    txt.replace(/\r/g," ")
       .replace(/\u00AD/g,"")
       .replace(/-\s*\n/g, "")
       .replace(/\s+\n/g, "\n")
       .replace(/\n+/g, " ")
       .replace(/\s+/g, " ")
       .trim();
  const mergeAbbrevs = (words) => {
    const out = [];
    for (let i=0; i<words.length; i++){
      const w = words[i];
      if (/^(?:[A-ZÇĞİÖŞÜ]\.)+$/.test(w)) { out.push(w); }
      else out.push(w);
    }
    return out;
  };
  const makeChunks = (words, size) => {
    const chunks = [];
    for (let i=0; i<words.length; i+=size){
      chunks.push(words.slice(i, i+size));
    }
    return chunks;
  };

  let playing = false;
  let idx = 0;
  let chunksArr = [];
  let timer = null;
  let totalShown = 0;
  let lastBreath = 0;

  const el = (id) => document.getElementById(id);
  const screen = el('screen');
  const wpm = el('wpm');
  const wpmVal = el('wpmVal');
  const chunkSel = el('chunk');
  const orpChk = el('orp');
  const breathChk = el('breath');
  const progress = el('progress');
  const input = el('input');
  const toggleBtn = el('toggle');

  const build = () => {
    const txt = normalize(input.value || "");
    if (!txt) { chunksArr = []; idx=0; updateProgress(); return; }
    const words = mergeAbbrevs(txt.split(" ").filter(Boolean));
    chunksArr = makeChunks(words, parseInt(chunkSel.value,10));
    idx = 0; totalShown = 0; lastBreath = 0;
    updateProgress();
  };

  const baseDelayMs = () => Math.round(60000 / parseInt(wpm.value,10));

  const renderChunk = (arr) => {
    const text = arr.join(" ");
    if (!orpChk.checked) { screen.innerHTML = text; return; }
    const target = arr.reduce((a,b)=> (b.replace(/[^A-Za-zÇĞİÖŞÜçğıöşü]/g,"").length > a.replace(/[^A-Za-zÇĞİÖŞÜçğıöşü]/g,"").length) ? b : a, arr[0]);
    const clean = target.replace(/[^A-Za-zÇĞİÖŞÜçğıöşü]/g,"");
    const orp = Math.min(calcOrpIndex(clean), Math.max(clean.length-1,0));
    const partA = clean.slice(0,orp), pivot = clean.slice(orp, orp+1), partB = clean.slice(orp+1);
    const highlighted = target.replace(clean, `${partA}<b>${pivot}</b>${partB}`);
    screen.innerHTML = text.replace(target, highlighted);
  };

  const updateProgress = () => {
    progress.textContent = `${Math.min(idx+1, Math.max(chunksArr.length,1))} / ${Math.max(chunksArr.length,0)}`;
  };

  const tick = () => {
    if (!playing || idx >= chunksArr.length) { playing = false; toggleBtn.textContent = 'Başlat'; return; }
    const current = chunksArr[idx];
    renderChunk(current);
    const perToken = Math.max(50, Math.round(baseDelayMs() / current.length));
    const longest = current.reduce((a,b)=> (b.length > a.length) ? b : a, current[0]);
    const longPenalty = longest.length >= 12 ? 90 : 0;
    const pDelay = punctDelay(current[current.length-1]);
    const breath = (breathChk.checked && totalShown >= lastBreath + 100) ? 1000 : 0;
    if (breath) lastBreath = totalShown;
    const delay = perToken + longPenalty + pDelay + breath;
    totalShown += current.length;
    idx++;
    updateProgress();
    timer = setTimeout(tick, delay);
  };

  wpm.addEventListener('input', () => { wpmVal.textContent = wpm.value; });
  ['input','change'].forEach(evt=>{
    chunkSel.addEventListener(evt, build);
    orpChk.addEventListener(evt, ()=> renderChunk(chunksArr[idx]||["Hazır"]));
    breathChk.addEventListener(evt, ()=>{});
  });

  el('toggle').addEventListener('click', ()=>{
    if (!chunksArr.length) build();
    playing = !playing;
    toggleBtn.textContent = playing ? 'Duraklat' : 'Başlat';
    if (playing) tick(); else if (timer) clearTimeout(timer);
  });
  el('back10').addEventListener('click', ()=>{
    idx = Math.max(0, idx - 10); updateProgress();
    if (!playing && chunksArr[idx]) renderChunk(chunksArr[idx]);
  });
  el('fwd10').addEventListener('click', ()=>{
    idx = Math.min((chunksArr.length-1), idx + 10); updateProgress();
    if (!playing && chunksArr[idx]) renderChunk(chunksArr[idx]);
  });
  el('reset').addEventListener('click', ()=>{
    if (timer) clearTimeout(timer);
    playing=false; toggleBtn.textContent='Başlat';
    idx=0; chunksArr=[]; totalShown=0; lastBreath=0; screen.textContent='Hazır'; updateProgress();
  });
  el('loadSample').addEventListener('click', ()=>{
    input.value = `Bu bir RSVP okuma denemesidir. Hızlı okuma için metin, kelime veya küçük gruplar halinde aynı noktada gösterilir. 
Noktalama işaretleri doğal ritim için gecikme ekler: örneğin, virgül sonrası kısa; nokta sonrası daha uzun bir duraklama yapılır.
Uzun kelimelerde algıyı kolaylaştırmak amacıyla ORP (Optimal Recognition Point) harfi vurgulanır. Hazırsan, "Başlat" tuşuna bas ve WPM değerini artırıp azaltarak kendine uygun hızı bul!`;
    build();
  });

  wpmVal.textContent = wpm.value;
  screen.textContent = "Hazır";
  updateProgress();
</script>
</body>
</html>
